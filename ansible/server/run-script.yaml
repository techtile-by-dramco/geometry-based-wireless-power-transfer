# Part of the redesigned client management system
# Run a script on the client and register the output
# ansible-playbook -i hosts.yaml run_status.yml --extra-vars "script_path=/tmp/my_script.sh" [--limit a-single host]
---
- name: Run status script asynchronously and check result
  hosts: all
  become: no
  vars:
    default_script_path: "/home/pi/check_status.sh"
    script_timeout: 3600  # max runtime in seconds
    sudo: "{{ sudo | default(no) }}" # sudo=[yes|no]
    sudo_flags: "{{ sudo_flags }}"

  tasks:
    - name: Set script path (use extra-var if provided, otherwise default)
      ansible.builtin.set_fact:
        script_path: "{{ script_path | default(default_script_path) }}"

    - name: Check if the script exists
      ansible.builtin.stat:
        path: "{{ script_path }}"
      register: script_stat

    - name: Fail if the script does not exist
      ansible.builtin.fail:
        msg: "The script {{ script_path }} does not exist!"
      when: not script_stat.stat.exists

    - name: Ensure the script is executable
      ansible.builtin.file:
        path: "{{ script_path }}"
        mode: "0755"
      when: script_stat.stat.exists

    - name: Run the script asynchronously
      ansible.builtin.command: "{{ script_path }}"
      become: "{{ sudo }}"
      become_flags: "{{ sudo_flags }}"
      async: "{{ script_timeout }}"
      poll: 0
      register: async_job
      when: script_stat.stat.exists

    - name: Wait for async job to finish
      ansible.builtin.async_status:
        jid: "{{ async_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: "{{ (script_timeout | int) // 10 }}"
      delay: 10
      when: script_stat.stat.exists

    - name: Fail if script result does not end with OK
      ansible.builtin.fail:
        msg: "The script reported: {{ job_result.stdout }}"
      when:
        - script_stat.stat.exists
        - not job_result.stdout | trim | regex_search('OK$')

    - name: Success message if output ends with OK
      ansible.builtin.debug:
        msg: "The script returned OK"
      when:
        - script_stat.stat.exists
        - job_result.stdout | trim | regex_search('OK$')
